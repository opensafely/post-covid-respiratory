# post-covid-respiratory

You can run this project via [Gitpod](https://gitpod.io) in a web browser by clicking on this badge: [![Gitpod ready-to-code](https://img.shields.io/badge/Gitpod-ready--to--code-908a85?logo=gitpod)](https://gitpod.io/#https://github.com/opensafely/post-covid-respiratory)

[View on OpenSAFELY](https://jobs.opensafely.org/repo/https%253A%252F%252Fgithub.com%252Fopensafely%252Fpost-covid-respiratory/)

Details of the purpose and any published outputs from this project can be found at the link above.

The contents of this repository MUST NOT be considered an accurate or valid representation of the study or its purpose. 
This repository may reflect an incomplete or incorrect analysis with no further ongoing work.
The content has ONLY been made public to support the OpenSAFELY [open science and transparency principles](https://www.opensafely.org/about/#contributing-to-best-practice-around-open-science) and to support the sharing of re-usable code for other subsequent users.
No clinical, policy or safety conclusions must be drawn from the contents of this repository.

# Repository navigation

-   If you are interested in how we defined our code lists, look in the [`codelists`](./codelists) folder.

-   Analyses scripts are in the [`analysis`](./analysis) directory:

    -   If you are interested in how we defined our variables, we use study definition scripts to define three cohorts: pre-vaccination, vaccinated and unvaccinated. Study start dates (i.e., index) and end dates differ by cohort and are all described in the protocol. Hence, we have a study definition for each; these are written in `python`. Extracted data is then combined to create our final cohorts, in the [preprocess data script](analysis/preprocess/preprocess_data.R).
    -   This directory also contains all the R scripts that process, describe, and analyse the extracted data.

-   The [`lib/`](./lib) directory contains a list of active analyses.

-   The [`project.yaml`](.project.yaml) defines run-order and dependencies for all the analysis scripts. This file should not be edited directly. To make changes to the yaml, edit and run the [`create_project.R`](./analysis/create_project.R) script which generates all the actions.

# Manuscript

This manuscript is currently being drafted.

# Code

The [`project.yaml`](./project.yaml) defines project actions, run-order and dependencies for all analysis scripts. **This file should *not* be edited directly**. To make changes to the yaml, edit and run the [`create_project.R`](./analysis/create_project.R) script instead. Project actions are then run securely using [OpenSAFELY Jobs](https://jobs.opensafely.org/repo/https%253A%252F%252Fgithub.com%252Fopensafely%252Fpost-covid-vaccinated). Details of the purpose and any published outputs from this project can be found at this link as well.

Below is a description of each action in the [`project.yaml`](./project.yaml) with arguments denoted by {arg} in the action name:

-   `vax_eligibility_inputs`
    -   Runs [`metadates.R`](./analysis/metadates.R) which creates metadata for aspects of the study design which are required for the `generate_study_population` actions.
    -   Creates dataframes that contain dates for each phase of vaccination and conditions for defining JCVI vacciantion groups
-   `generate_study_population_{cohort}`
    -   There are three `generate_study_population` scripts that are run to create the three cohorts: prevaccinated (`prevax`), vaccinated (`vax`) and electively unvaccinated (`unvax`). These are [`study_definition_prevax.py`](./analysis/study_definition_prevax.py), [`study_definition_vax.py`](./analysis/study_definition_vax.py), [`study_definition_unvax.py`](./analysis/study_definition_unvax.py) and [`study_definition_prelim.py`](./analysis/study_definition_prelim.py).
    -   These scripts are used to define JCVI groups, vaccine variables, variables used to apply eligibility criteria, outcome variables and covariates. Common variables used in all three scripts can be found in [`common_variables.py`](./analysis/common_variables.py).
-   `preprocess data - {cohort}`
    -   Runs [`preprocess_data.R`](./analysis/preprocess/preprocess_data.R) to tidy `input_{cohort}.rds` (generated by `generate_study_population_{cohort}`
    -   Tidies vaccine variables, determines patient study index date, creates additional variables (e.g. covid phenotype), tidies dataset and ensures all variables are in the correct format e.g. numeric, character etc.
-   `stage1_data_cleaning_{cohort}`
    -   Runs [`Stage1_data_cleaning.R`](./analysis/preprocess/Stage1_data_cleaning.R)
    -   Applies quality assurance rule and inclusion/exclusion criteria
    -   Creates output file `input_{cohort}_stage1.rds` with covariates for each cohort.
    -   Used in `create_stage1_ids` and `process_repeat_events_{cohort}`.
-   `create_stage1_ids`
    -   Runs [`Stage1_ids.R`](./analysis/preprocess/Stage1_ids.R) which creates a list of IDs for all cohorts using `input_{cohort}_stage1.rds`.
    -   Used in `study_definition_repeat_events_1`.
-   `generate_study_population_repeat_events_1`
    -   Runs [`study_definition_repeat_events_1`](./analysis/study_definition_repeat_events_1.py).
    -   Extracts the first `repeat_events_steps$upper[1]` events for each outcome [`repeat_events_steps.R`](./analysis/repeat_events/repeat_events_steps.R) as well as the total number of events in the full study period for each outcome.
-   `preflight_repeat_events_{step}`
    -   Runs [`preflight_repeat_events.R`](./analysis/repeat_events/preflight_repeat_events.R) which creates the files required for `study_definition_repeat_events_{step}`.
    -   When step = 2, the code also creates [`max_events.json`](./output/repeat_events/max_events.json.R) with the maximum number of events for each outcome `max_events[{outcome}]`.
-   `generate_study_population_repeat_events_{step}`
    -   Runs [`study_definition_repeat_events_x`](./analysis/study_definition_repeat_events_x.py).
    -   Extracts the events from `repeat_events_steps$lower[{step}]` to `repeat_events_steps$upper[{step}]`.
    -   `repeat_events_steps$upper[{step}]` is updated to be the minumum of `repeat_events_steps$upper[{step}]` and `max_events[{outcome}]`.
-   `join_repeat_events`
    -   Runs [`join_repeat_events`](./analysis/repeat_events/join_repeat_events.R).
    -   Joins the output files generated by `generate_study_population_repeat_events_1` and `generate_study_population_repeat_events_x` and converts data to long.
    -   Used in `process_repeat_events_{cohort}`.
-   `process_repeat_events_{cohort}`
    -   Runs [`process_repeat_events`](./analysis/repeat_events/process_repeat_events.R).
    -   Creates episode data by cohort, outcome and population.
    -   **To do** Adds covariate data using `input_{cohort}_stage1.rds`.
    -   Saves datasets ready for analysis.

# About the OpenSAFELY framework

The OpenSAFELY framework is a Trusted Research Environment (TRE) for electronic
health records research in the NHS, with a focus on public accountability and
research quality.

Read more at [OpenSAFELY.org](https://opensafely.org).

# Licences
As standard, research projects have a MIT license. 
